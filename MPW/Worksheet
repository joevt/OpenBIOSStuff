#=======================================================================================================# These tools use MPW which you can download from Apple at# http://developer.apple.com/tools/mpw-tools/## Use the commands in this Worksheet file (substitute your folder paths and# rom names). To execute a command, select the line or lines and press the enter key.## DumpPCIRom			 	- MPW script that converts a PCI ROM image into Forth source code.#								Works on any PCI card ROM that contains an Open Firmware FCode image.# detok						- MPW tool that takes an FCode image (as in part of a PCI ROM) and outputs#								the FCode tokens to a text file. detok also works on Mac ROM dumps (the#								Open Firmware related parts) and memory dumps (e.g. compiled FCode from#								Open Firmware).# toke						- MPW tool that takes Forth source code and creates an FCode image. Can#								also create a PCI ROM image.# ConvertFCodeTokensToForth - MPW script that converts text produced by detok into Forth source code.# DumpPCIRomStreamEdit2		- StreamEdit script used in DumpPCIRom# DumpPCIRomStreamEdit1		- StreamEdit script used in DumpPCIRom## Not included:# - PCI ROM MPW makefile example - to build a flasher using a single key press.# - a preprocessor script - used in makefile to build different versions of a ROM using the same Forth source code - e.g. for different chips or features or ROM sizes.# - Mac ROM dump processing scipt - separates the compiled FCode from regular FCode, converts regular FCode to Forth, useful if you need to see how things work or to make an Open Firmware patch.##=======================================================================================================# Set up some environment variables that the scripts depend on - you need to change the path for the TempFolder and MPWCommands. These 3 lines should be placed in a UserStartup script (look at the MPW Startup script for more info).Set -e TempFolder "MacOS9:System Folder:Preferences:MPW:TempMPW:" # This may already be setup for you - if so, then remove this lineSet -e MPWCommands "Testing:MPW-GM:Tokenizer:" # I keep all custom scripts and tools and aliases in a separate folder (called MPWCommands) outside the MPW folder. You can also use the User Commands folder inside the MPW folder.Set -e Commands "{{Commands}},{{MPWCommands}}" # Add our custom commands folder to the list of MPW's commands folders.# Change the directory to where the rom is located. You can drag and drop files and folders into an MPW window to get the full path of them.Directory "Testing:MPW-GM:GeForce7800:"# Convert the rom to a Forth source file - this will take a while because MPW scripts are slow. Maybe someone can figure out what ConvertFCodeTokensToForth does and put that in detok...DumpPCIRom "nvidia.rom" > "nvidia.4th" ³ "nvidia.Errs"	# The .Errs file (output from DumpPCIRom and the tools it uses) begins with	# a list of different kinds of definitions that were not used in the ROM	# (this was for debugging purposes to help create a test Forth source code	# file that contained all types of code that ConvertFCodeTokensToForth	# searches for). You can ignore that part. The lines of errors that look like this:	#	# Line 2164 # ...	#	# are noting lines that may be of interest. The line number refers to the	# lines in the {TempFolder}FCode0.4th file which is the unprocessed output	# of the detok tool that DumpPCIRom uses. You can probably ignore the	# "New FCode" messages.# Open the Forth source file so you can make your changes.Open "nvidia.4th"Format -f Monaco -s 9 -t 4 "nvidia.4th"# Convert the Forth source file to a rom image.toke -l -o "nvidMod.rom" "nvidia.4th"# Convert the modified rom image back to a Forth source file so it can be verified by comparison with the firsr Forth source file.DumpPCIRom "nvidMod.rom" > "nvidMod.4th" ³ "nvidMod.Errs"# Compare to make sure toke worked correctly (note: offsets are smaller because toke is smart enough to use specific 1 byte tokens for the numbers -1, 0, 1, 2, and 3 instead of a "b(lit)" token which takes 5 bytes.Comparefiles -topdown "nvidia.4th" "nvidMod.4th"